---
title: 所遇问题
tags: Vue 项目 后台管理
toc: true
date: 2020-04-20
categories:
- [Vue, 项目, 游乐招商]
---

### 页面布局

#### 容器 login error 页面一级路由

#### 背景图不显示

```css
背景图不显示, 是因为父级没有高度， 用vh  可视区域分成100份
```

#### 侧边栏布局

```css
components/home 创建layout-aside  然后再home组件内引入 注册使用

注册
<script>
import LayoutAside from '../components/home/layout-aside'
export default {
  name: 'Home',
  components: {
    'layout-aside': LayoutAside
  }
}
</script>

使用
<el-aside>
    <layout-aside></layout-aside>
</el-aside>
```

#### 修改 elementUI 元素样式

```css
<el-form-item
  > <el-checkbox
  v-model="checked"
  > 请勾选协议(必选项)</el-checkbox
  > </el-form-item
  > /deep/
  .el-form-item__content {
  line-height: 0px;
}
```

#### ElementUI 全局注册插件封装(页面布局、面包屑导航)
```js
import layoutAside from './home/layout-aside'
import layoutHeader from './home/layout-header'

// 所有自定义组件的插件
export default {
  install: function (Vue) {
    Vue.component('layout-aside', layoutAside) // 注册 左侧导航组件
    Vue.component('layout-header', layoutHeader) // 注册头部组件
  }
}


面包屑导航通过 具名插槽的方式 传入当前页面的名称
```
### axios 封装
#### 封装总结
```js
请求拦截器 响应拦截器  发送前数据处理  接收前数据处理  统一错误状态码处理
```
#### 封装逻辑
```js
import axios from 'axios'
import router from '../router'
import { Message } from 'element-ui'
import JSONBig from 'json-bigint'
axios.defaults.baseURL = 'http://ttapi.research.itcast.cn/mp/v1_0'
axios.interceptors.request.use(function (config) {
// 发送请求做一些逻辑处理
// config 是要发送请求的配置信息
  const token = window.localStorage.getItem('user_token')
  config.headers.Authorization = `Bearer ${token}`
  return config
}, function (error) {
  return Promise.reject(error)
})
//
axios.defaults.transformResponse = [function (data) {
  // return JSON.parse(data)
  return data ? JSONBig.parse(data) : {}
}]
axios.interceptors.response.use(function (response) {
  // debugger
  return response.data ? response.data : {}
}, function (error) {
  // debugger
  const status = error.response.status
  // console.log(status)
  let message = '未知错误'
  switch (status) {
    case 400:
      message = '请求参数错误'
      break
    case 403:
      message = '没有token 过期'
      break
    case 507:
      message = '服务器数据库异常'
      break
    case 401:
      message = 'token过期或未出'
      window.localStorage.clear() // 清空缓存
      router.push('/login') // this.$router.push()
      break
    case 404:
      message = '手机号不正确'
      break
    default:
      break
  }
  Message({ message })
  return Promise.reject(error)
})
export default axios

```
### 登录
#### 总结
```js
设计三点 token的存储及携带  页面权限(导航守卫)
```
#### 退出
```js
    //   点击菜单项时触发
    clickMenu (command) {
      if (command === 'info') {

      } else if (command === 'git') {
        //   跳转到git地址
        window.location.href = 'https://github.com/shuiruohanyu/90heimatoutiao'
      } else {
        //    退出
        window.localStorage.removeItem('user-token') // 删除令牌
        this.$router.push('/login') // 回到登录页
      }
    }
```
#### token存储在本地
```js
      this.$axios({
            url: '/authorizations', // 请求地址 axios 没有指定 类型 默认走get类型
            method: 'post', // 类型
            data: this.loginForm // body 参数
          }).then(result => {
            // 只接受正确结果
            // 前端缓存 登录成功返回给我们的令牌
            window.localStorage.setItem('user-token', result.data.data.token)
          }).catch(() => {

          })
```
#### token 携带--请求拦截器
```js
// 负责对axios进行处理
import axios from 'axios'
axios.interceptors.request.use(function (config) {
  // 在发起请求请做一些业务处理
  // config是要发送请求的配置信息
  let token = window.localStorage.getItem('user-token') // 获取token
  config.headers['Authorization'] = `Bearer ${token}` // 统一注入token 到headers属性 因为所有接口要求的token格式是一样的
  return config
}, function (error) {
  // 对请求失败做处理
  return Promise.reject(error)
})
export default axios
```

#### 页面进入权限
```js
 next()`** =>表示 resolve => 表示放过当前的请求

**`next(false)`**: 中断当前的导航

 **`next(地址)`** 拦截即将要去的地方 转到另外一个地址

 router.beforeEach  => 全局前置守卫 => 在每一个路由发生改变之前 会触发这个事件


  router.beforeEach(function(to,from,next){})


  login => home

  this.$route.path

  to: Route**: 即将要进入的目标 [路由对象](https://router.vuejs.org/zh/api/#路由对象)

  from: Route**: 当前导航正要离开的路由

  next: Function**: 一定要调用该方法来 **resolve** 这个钩子。执行效果依赖 `next` 方法的调用参数。

 
  new Promise(function(resolve,reject){   }).then
 

   next函数必须执行 =>不执行 就会死在跳转的位置
   如果直接执行next() => 表示一切正常 login => home 可以正常走   类似 callback()
   next(false)** => 中断当前的导航 =>  login => home 不能正常走  停在login
  next(地址)** => 强制将login=>home =>另一个地址 

  代码====>创建permission 引入router  然后再main.js引入permission

  // 处理路由拦截器 导航守卫
import router from '../router'

// 全局前置守卫  当 路由发生变化时 这个方法里的回调函数就会执行
router.beforeEach(function (to, from, next) {
  // 权限拦截 认为有token 让过去 没token不让过
  if (to.path.startsWith('/home')) {
    //   确定要去检查的范围
    let token = window.localStorage.getItem('user-token')
    if (token) {
      next() // 放过
    } else {
      next('/login') // 跳转到登录页
    }
  } else {
    next() // 直接放过
  }
})
```


### 业务功能
#### 评论列表---打开关闭
##### 打开关闭
```js
      this.$confirm(`您是否确定要${mess}评论吗`, '提示').then(() => {
        // 调用接口
        this.$axios({
          method: 'put',
          url: '/comments/status',
          params: { article_id: row.id },
          data: { allow_comment: !row.comment_status } // 因为当前如果是打开 ,就要关闭 如果是关闭 就要打开
        }).then(result => {
          //  表示执行成功
          this.getComment() // 重新拉取评论管理数据
        })
      })
```
##### 列表分页
```js
放置一个分页组件
 <el-row type='flex' justify="center" align="middle" style="height:80px">
      <!-- 分页组件 total 总页码  每页多少条-->
      <el-pagination background layout="prev, pager, next"
       :current-page="page.currentPage"
       :page-size="page.pageSize"
       :total="page.total"
       @current-change="changePage"
       ></el-pagination>
    </el-row>

   total  => 总条数 
 page-size => 每页多少条
 current-page => 当前页码
 @current-change => 当前页码改变触发的事件 => 将最新页码 赋值给当前页码 => 请求数据

     // 页码改变事件
    changePage (newPage) {
      this.page.currentPage = newPage // 最新的页码
      this.getComment()
    },
```

##### 优化---加载状态
```js
   getComment () {
      this.loading = true // 打开进度条
      this.$axios({
        url: '/articles',
        params: { response_type: 'comment', page: this.page.currentPage, per_page: this.page.pageSize }
      }).then(result => {
        this.list = result.data.results
        this.page.total = result.data.total_count // 总条数
        this.loading = false
        // setTimeout(() => { this.loading = false }, 300) // 关闭
      })
    },
```

#### 素材列表
##### 布局
```css
   <el-tabs v-model="activeName">
          <!-- 标签 -->
          <el-tab-pane label="全部图片" name="all">全部</el-tab-pane>
          <el-tab-pane label="收藏图片" name="collect">收藏</el-tab-pane>
      </el-tabs>
```

#####
```js
- 收藏 和全部 要公用一个list数据
- 由于当前只能看到一个页签 ,所以当点击页签时 ,就
去加载点击页签的数据,就可以保证数据的正确

export default {
  data () {
    return {
      activeName: 'all', // 当前选中的标签
      list: [] // 接收素材数据
    }
  },
  methods: {
    // 切换页签方法
    changeTab () {
      this.getMaterial() // 调用获取数据方法
    },
    // 获取素材的方法
    getMaterial () {
      this.$axios({
        url: '/user/images',
        params: {
          collect: this.activeName === 'collect' // 传false是获取所有的数据 传true是获取收藏数据
        }
      }).then(result => {
        this.list = result.data.results // 获取图片数据 有可能是 全部 也由可能是收藏
      })
    }
  },
  created () {
    this.getMaterial()
  }
}
```

##### 素材列表-分页组件及请求
```js
<!-- 公共分页组件 -->
        <el-row type="flex" justify="center">
           <el-pagination
               :current-page="page.currentPage"
               :page-size="page.pageSize"
               :total="page.total"
               @current-change="changePage"
               background
               layout="prev, pager, next"
              >
           </el-pagination>
         </el-row>

 js代码
  export default {
    data () {
      return {
        activeName: 'all', // 当前选中的标签
        list: [], // 接收素材数据
        page: {
          currentPage: 1,
          pageSize: 8,
          total: 0
        }
      }
    },
    methods: {
      // 改变页码方法
      changePage (newPage) {
        this.page.currentPage = newPage
        this.getMaterial()
      },
      // 切换页签方法
      changeTab () {
        this.page.currentPage = 1 // 重置回第一页
        this.getMaterial() // 调用获取数据方法
      },
      // 获取素材的方法
      getMaterial () {
        this.$axios({
          url: '/user/images',
          params: {
            page: this.page.currentPage,
            per_page: this.page.pageSize,
            collect: this.activeName === 'collect' // 传false是获取所有的数据 传true是获取收藏数据
          }
        }).then(result => {
          this.list = result.data.results // 获取图片数据 有可能是 全部 也由可能是收藏
          this.page.total = result.data.total_count // 总条数
        })
      }
    },
    created () {
      this.getMaterial()
    }
  }


   全部 /收藏 共用了list,共用了分页组件
 切换页签 => 将页码重置到了第一页
 切换页码 =>  将最新页码 赋值给了当前页
```
#### 素材

##### 素材上传
```js
- 上传接口 => 接口 formdata类型
- 上传组件 => elementUI => upload

// 上传图片方法
    uploadImg (params) {
      this.loading = true // 先弹个层
      let data = new FormData()
      data.append('image', params.file) // 文件加入到参数中
      this.$axios({
        method: 'post',
        url: '/user/images',
        data
      }).then(result => {
        this.loading = false // 关闭弹层
        this.getMaterial() // 直接调用拉取数据的方法
      })
    },
```
##### 素材收藏删除
```js
  // 取消或者收藏
    collectOrCancel (item) {
      // item.iscollected true => 取消收藏 ? 收藏
      this.$axios({
        method: 'put',
        url: `/user/images/${item.id}`,
        data: {
          collect: !item.is_collected // 取反 因为 收藏  =>取消收藏
        }
      }).then(result => {
        this.getMaterial() // 重新拉取数据
      })
    }

     // 删除用户图片素材
    delMaterial (id) {
      this.$confirm('你确定要删除此图片吗?').then(() => {
        this.$axios({
          method: 'delete',
          url: `/user/images/${id}`
        }).then(() => {
          this.getMaterial() // 重新拉取数据
        })
      })
    },
```

#### 内容列表

##### 页面主体结构
```js
  <el-card class='articles'>
        <bread-crumb slot='header'>
           <template slot='title'>文章列表</template>
        </bread-crumb>
        <!-- 表单容器 -->
        <el-form style="padding-left:50px">
            <el-form-item label="文章状态:">
                <!-- 放置一个单选组  文章状态，0-草稿，1-待审核，2-审核通过，3-审核失败，4-已删除，不传为全部-->
                <el-radio-group v-model="searchForm.status">
                    <!-- label -->
                    <el-radio :label="5">全部</el-radio>
                    <el-radio :label="0">草稿</el-radio>
                    <el-radio :label="1">待审核</el-radio>
                    <el-radio :label="2">审核通过</el-radio>
                    <el-radio :label="3">审核失败</el-radio>
                </el-radio-group>
            </el-form-item>
            <el-form-item label="频道列表:">
                <el-select placeholder="请选择频道" v-model="searchForm.channel_id">
                    <!-- el-option label是显示值 value是存储值 -->
                    <el-option v-for="item in channels" :key="item.id" :label="item.name" :value="item.id"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="时间选择:">
                <!-- 日期选择器 日期范围-->
                <el-date-picker v-model="searchForm.dateRange" type="daterange"></el-date-picker>
            </el-form-item>
        </el-form>
        <el-row class='total' type='flex' align="middle">
            <span>
                共找到10000条符合条件的内容
            </span>
        </el-row>
        <div class='article-item' v-for="item in 100" :key="item">
            <!-- 左侧 -->
            <div class='left'>
                <img src="../../assets/img/default.jpg" alt="">
                <div class='info'>
                    <span>90期的弟弟们，哈哈哈啊哈哈哈嗝</span>
                    <el-tag class='tag'>标签一</el-tag>
                    <span class='date'>2019-12-24 15:07:01</span>
                </div>
            </div>
            <!-- 右侧 -->
            <div class='right'>
                <span><i class="el-icon-edit"></i>修改</span>
                <span><i class="el-icon-delete"></i>删除</span>
            </div>
        </div>
    </el-card>
```

#####  先不做筛选,不做分页

```js
- 调用接口 =>先不做筛选,不做分页
- 过滤器 不但可以用在插值表达式 
- 还可以用在 v-bind表达式

  <div class='article-item' v-for="item in list" :key="item.id.toString()">
        <!-- 左侧 -->
        <div class='left'>
            <img :src="item.cover.images.length ? item.cover.images[0] : defaultImg" alt="">
            <div class='info'>
                <span>{{ item.title }}</span>
                <!-- 文章状态 0-草稿，1-待审核，2-审核通过，3-审核失败，4-已删除 -->
                <el-tag :type="item.status | filterType" class='tag'>{{ item.status | filterStatus }}</el-tag>
                <span class='date'>{{ item.pubdate }}</span>
            </div>
        </div>
        <!-- 右侧 -->
        <div class='right'>
            <span><i class="el-icon-edit"></i>修改</span>
            <span><i class="el-icon-delete"></i>删除</span>
        </div>
    </div>

       getArticles () {
        this.$axios({
          url: '/articles'
        }).then(result => {
          this.list = result.data.results // 获取文章列表数据
        })
      }
```
##### 内容列表-页面结构-搜索筛选

```js
条件 => 组合条件 => 不论谁的数据发生变化 =>先组装条件  => 统一发送请求
第一种做法=>监听每个组件的change事件
changeCondition () {
   let params = {
     status: this.searchForm.status === 5 ? null : this.searchForm.status, // 因为5是前端定义的一个标识, 如果等于5 表示查全部, 全部应该什么都不传 直接传null
     channel_id: this.searchForm.channel_id,
     begin_pubdate: this.searchForm.dateRange.length ? this.searchForm.dateRange[0] : null, // 开始时间
     end_pubdate: this.searchForm.dateRange.length > 1 ? this.searchForm.dateRange[1] : null // 截止时间
   }
   this.getArticles(params)
 }

第二种做法 => watch 去监听数据变化
   watch: {
      name: function(newValue,oldValue){
          
      }
  }
  // 传统模式  a: { b:{c:'123'} }
  watch:{
     "a.b.c":function(){}
  }
  watch: {
      a:{
          handler:function(){
              // this指向当前实例
          } // handler是一个固定写法 默认对象中任何的变化都会触发该函数
          deep: true // deep 深度检测 不论嵌套多少层 都可以监听到改变
      }
  }
```


##### 内容列表-分页请求
```js
   //   改变页码方法
    changePage (newPage) {
      this.page.currentPage = newPage // 最新页码
      this.getConditionArticle() // 调用获取文章数据
    },
    //   改变条件
    changeCondition () {
      this.page.currentPage = 1 // 强制将页码重置第一页
      this.getConditionArticle() // 调用获取文章数据
    },
    getConditionArticle () {
      let params = {
        page: this.page.currentPage,
        per_page: this.page.pageSize,
        status: this.searchForm.status === 5 ? null : this.searchForm.status, // 因为5是前端定义的一个标识, 如果等于5 表示查全部, 全部应该什么都不传 直接传null
        channel_id: this.searchForm.channel_id,
        begin_pubdate: this.searchForm.dateRange.length ? this.searchForm.dateRange[0] : null, // 开始时间
        end_pubdate: this.searchForm.dateRange.length > 1 ? this.searchForm.dateRange[1] : null // 截止时间
      }
      this.getArticles(params)
    }
```

 
##### 内容列表-删除内容
```js
 delMaterial (id) {
      this.$confirm('是否要删除该文章?').then(() => {
        // 调用删除接口
        this.$axios({
          method: 'delete',
          url: `/articles/${id.toString()}`
        }).then(result => {
          // 提示
          this.$message({
            type: 'success',
            message: '删除成功'
          })
          // 重新拉取数据
          // this.page.currentPage = 1 // 根据业务 处理 如果删除了数据 是否回到第一页根据具体业务而定
          this.getConditionArticle()
        })
      })
    }
```


#### token 携带
```js
```


#### token 携带
```js
```

#### token 携带
```js
```

#### token 携带
```js
```

